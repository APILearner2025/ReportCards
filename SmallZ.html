<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Player Matches Analysis</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background-color: #1e1e2f;
        color: #e0e0e0;
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      h1 {
        color: #81a1c1;
        text-align: center;
        margin-bottom: 20px;
      }

      #summary {
        background-color: #2a2a3f;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }

      #summary p {
        font-size: 16px;
        margin: 8px 0;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .stat-card {
        background-color: #2d2d45;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-title {
        font-size: 14px;
        color: #b0b0b0;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 500;
        color: #81a1c1;
      }

      #matches-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(650px, 1fr));
        gap: 20px;
      }

      .match {
        background-color: #2a2a3f;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .match-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px solid #3e3e5f;
      }

      .match-id {
        font-size: 14px;
        font-weight: 500;
      }

      .match-result {
        display: flex;
        align-items: center;
        font-weight: 500;
        padding: 6px 12px;
        border-radius: 6px;
      }

      .win {
        background-color: rgba(46, 125, 50, 0.3);
        color: #81c784;
      }

      .loss {
        background-color: rgba(198, 40, 40, 0.3);
        color: #e57373;
      }

      .match a {
        color: #81a1c1;
        text-decoration: none;
        transition: color 0.2s;
      }

      .match a:hover {
        color: #5e81ac;
        text-decoration: underline;
      }

      .stats-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .stats-table th {
        text-align: left;
        padding: 10px 8px;
        color: #b0b0b0;
        font-weight: 500;
        border-bottom: 1px solid #3e3e5f;
      }

      .stats-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #2d2d45;
      }

      .stats-table tr:last-child td {
        border-bottom: none;
      }

      .hero-cell {
        display: flex;
        align-items: center;
      }

      .hero-cell img {
        width: 32px;
        height: 32px;
        margin-right: 12px;
        border-radius: 6px;
      }

      .player-name {
        font-weight: 500;
      }

      .kda {
        display: flex;
        justify-content: center;
        font-variant-numeric: tabular-nums;
      }

      .kills {
        color: #6e8c6e;
        font-weight: 500;
      }

      .deaths {
        color: #a05b5b;
        font-weight: 500;
      }

      .assists {
        color: #637ea6;
        font-weight: 500;
      }

      .slash {
        color: #e0e0e0;
        margin: 0 2px;
      }

      .damage-number {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .loading {
        text-align: center;
        padding: 40px;
        font-size: 18px;
        color: #81a1c1;
      }

      .error {
        background-color: #a05b5b;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }

      .cs-min {
        color: #d8a0a6;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        #matches-grid {
          grid-template-columns: 1fr;
        }

        .stats-table {
          font-size: 12px;
        }

        .stats-table th,
        .stats-table td {
          padding: 8px 4px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Team Match Analysis</h1>

      <div id="summary">
        <div class="loading">Loading match data...</div>
      </div>
      <div id="matches-grid"></div>
    </div>

    <script>
      const endpoint = "https://pred.gg/gql";
      const PLAYER_UUIDS = [
        "72890d83-6edd-4d26-b747-f9fe65da64fa",
        "eb8434a3-52e0-46de-a4bd-18feb627f694",
        "64469def-f40d-49ae-a505-b3d83d28ad40",
        "10df9935-5564-4756-9a71-b91e5f3f85d0",
        "eef2ee34-466a-49e3-8cc2-0f3c524bc532",
      ]; // We'll analyze these specific players

      const DAYS = 30;

      function getAssetPath(hash) {
        return hash ? `https://pred.gg/assets/${hash}.webp` : "";
      }

      async function getAccessToken() {
        const tokenUrl = "https://pred.gg/api/oauth2/token";
        const clientId = "yc1bxmxwqiw01igf23nbavobwy6lvhe6";
        const clientSecret = "ommpwilb29mfylrtjeldpqqfc11zbhqs";

        const basicAuth = "Basic " + btoa(`${clientId}:${clientSecret}`);

        const response = await fetch(tokenUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Authorization: basicAuth,
          },
          body: new URLSearchParams({
            grant_type: "client_credentials",
          }).toString(),
        });

        if (!response.ok) {
          console.error(await response.text());
          throw new Error("Failed to fetch access token");
        }

        const data = await response.json();
        return data.access_token;
      }

      // Query to get player matches with ARAM filtering
      const playerMatchesQuery = `
    query PlayerMatches($uuid: UUID!, $offset: Int, $limit: Int) {
      player(by: { uuid: $uuid }) {
        matchesPaginated(offset: $offset, limit: $limit) {
          results {
            match {
              id
              uuid
              duration
              gameMode
              region
              winningTeam
              endTime
              matchPlayers {
                player {
                  uuid
                  name
                }
                team
                kills
                deaths
                assists
                heroDamage
                totalDamageDealtToStructures
                totalDamageDealtToObjectives
                minionsKilled
                hero {
                  id
                  slug
                  data {
                    icon
                    displayName
                  }
                }
              }
            }
          }
          totalCount
        }
      }
    }
  `;

      async function fetchGraphQL(query, variables) {
        const token = await getAccessToken();
        const response = await fetch(endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ query, variables }),
        });
        const json = await response.json();
        if (json.errors) throw new Error(JSON.stringify(json.errors));
        return json.data;
      }

      async function getPlayerMatches(uuid, limit = 100) {
        let allMatches = [];
        let offset = 0;
        const batchSize = 50;

        try {
          while (allMatches.length < limit) {
            const data = await fetchGraphQL(playerMatchesQuery, {
              uuid,
              offset,
              limit: batchSize,
            });

            if (
              !data ||
              !data.player ||
              !data.player.matchesPaginated ||
              !data.player.matchesPaginated.results.length
            ) {
              break;
            }

            const results = data.player.matchesPaginated.results;
            allMatches = allMatches.concat(results);

            // Stop if we've gotten all matches or reached our limit
            if (results.length < batchSize || allMatches.length >= limit) {
              break;
            }

            offset += batchSize;
          }

          // Filter for ARAM matches only and within timeframe
          const cutoffDate = new Date(Date.now() - DAYS * 24 * 60 * 60 * 1000);
          return allMatches
            .filter(({ match }) => match.gameMode === "ARAM")
            .filter(({ match }) => new Date(match.endTime) >= cutoffDate);
        } catch (error) {
          console.error(`Error fetching matches for player ${uuid}:`, error);
          return [];
        }
      }

      async function getAramLeaderboard() {
        try {
          // Get ARAM matches for all players
          const allPlayerMatches = await Promise.all(
            PLAYER_UUIDS.map((uuid) => getPlayerMatches(uuid))
          );

          // Calculate stats for each player
          const playerStats = PLAYER_UUIDS.map((uuid, index) => {
            const matches = allPlayerMatches[index];
            const aramMatches = matches.filter(
              ({ match }) => match.gameMode === "ARAM"
            );

            let wins = 0;
            let losses = 0;
            let totalKills = 0;
            let totalDeaths = 0;
            let totalAssists = 0;
            let totalHeroDamage = 0;
            let totalMinionsKilled = 0;
            const heroesPlayed = new Map();

            aramMatches.forEach(({ match }) => {
              const playerMatchData = match.matchPlayers.find(
                (mp) => mp.player.uuid === uuid
              );
              if (playerMatchData) {
                const isWin = playerMatchData.team === match.winningTeam;

                if (isWin) wins++;
                else losses++;

                totalKills += playerMatchData.kills;
                totalDeaths += playerMatchData.deaths;
                totalAssists += playerMatchData.assists;
                totalHeroDamage += playerMatchData.heroDamage;
                totalMinionsKilled += playerMatchData.minionsKilled;

                // Track hero usage
                const heroName = playerMatchData.hero.data.displayName;
                heroesPlayed.set(
                  heroName,
                  (heroesPlayed.get(heroName) || 0) + 1
                );
              }
            });

            const totalMatches = wins + losses;
            const winRate =
              totalMatches > 0
                ? ((wins / totalMatches) * 100).toFixed(1)
                : "0.0";
            const kda =
              totalDeaths === 0
                ? (totalKills + totalAssists).toFixed(2)
                : ((totalKills + totalAssists) / totalDeaths).toFixed(2);
            const avgHeroDamage =
              totalMatches > 0 ? Math.round(totalHeroDamage / totalMatches) : 0;

            const favoriteHero =
              heroesPlayed.size > 0
                ? Array.from(heroesPlayed.entries()).sort(
                    (a, b) => b[1] - a[1]
                  )[0][0]
                : "None";

            return {
              uuid,
              name:
                aramMatches.length > 0
                  ? aramMatches[0].match.matchPlayers.find(
                      (mp) => mp.player.uuid === uuid
                    ).player.name
                  : "Unknown",
              wins,
              losses,
              totalMatches,
              winRate,
              kda,
              avgHeroDamage,
              totalHeroDamage,
              favoriteHero,
              totalKills,
              totalDeaths,
              totalAssists,
            };
          });

          return playerStats.filter((player) => player.totalMatches > 0);
        } catch (error) {
          console.error("Error generating ARAM leaderboard:", error);
          throw error;
        }
      }

      // Execute the data fetching and display
      getAramLeaderboard()
        .then((players) => {
          // Sort by wins (descending)
          const sortedPlayers = players.sort((a, b) => b.wins - a.wins);

          const summaryContainer = document.getElementById("summary");
          summaryContainer.innerHTML = `
        <h2>üèÜ ARAM Leaderboard (Last ${DAYS} Days)</h2>
        <p>Tracking ${PLAYER_UUIDS.length} players</p>
        <p>Timeframe: Last ${DAYS} days ‚Ä¢ Game Mode: ARAM Only</p>
      `;

          const grid = document.getElementById("matches-grid");
          grid.innerHTML = "";

          if (sortedPlayers.length === 0) {
            grid.innerHTML =
              '<div class="loading">No ARAM matches found for the selected players in the specified timeframe</div>';
            return;
          }

          // Create leaderboard table
          const table = document.createElement("table");
          table.className = "aram-leaderboard";

          table.innerHTML = `
        <thead>
          <tr>
            <th>Rank</th>
            <th>Player</th>
            <th>Wins</th>
            <th>Losses</th>
            <th>Win Rate</th>
            <th>Total Matches</th>
            <th>KDA</th>
            <th>Avg Damage</th>
            <th>Total K/D/A</th>
            <th>Favorite Hero</th>
          </tr>
        </thead>
        <tbody>
          ${sortedPlayers
            .map(
              (player, index) => `
            <tr>
              <td class="rank">#${index + 1}</td>
              <td class="player-info">
                <a class="player-name" href="https://pred.gg/players/${
                  player.uuid
                }" target="_blank">
                  ${player.name}
                </a>
              </td>
              <td class="wins">${player.wins}</td>
              <td class="losses">${player.losses}</td>
              <td class="win-rate ${
                parseFloat(player.winRate) >= 50 ? "positive" : "negative"
              }">
                ${player.winRate}%
              </td>
              <td>${player.totalMatches}</td>
              <td class="kda">${player.kda}</td>
              <td class="damage">${player.avgHeroDamage.toLocaleString()}</td>
              <td class="total-kda">${player.totalKills}/${
                player.totalDeaths
              }/${player.totalAssists}</td>
              <td class="hero">${player.favoriteHero}</td>
            </tr>
          `
            )
            .join("")}
        </tbody>
      `;

          grid.appendChild(table);

          // Add CSS styling
          const style = document.createElement("style");
          style.textContent = `
        .aram-leaderboard {
          width: 100%;
          border-collapse: collapse;
          background: #1a1a1a;
          border-radius: 8px;
          overflow: hidden;
          font-size: 14px;
        }
        .aram-leaderboard th {
          background: #2a2a2a;
          padding: 12px 8px;
          text-align: left;
          font-weight: 600;
          color: #fff;
          border-bottom: 2px solid #333;
          white-space: nowrap;
        }
        .aram-leaderboard td {
          padding: 10px 8px;
          border-bottom: 1px solid #333;
          color: #ccc;
        }
        .aram-leaderboard tr:hover {
          background: #2a2a2a;
        }
        .rank {
          font-weight: bold;
          color: #ffd700;
          text-align: center;
        }
        .wins {
          color: #4CAF50;
          font-weight: bold;
          text-align: center;
        }
        .losses {
          color: #f44336;
          text-align: center;
        }
        .win-rate.positive {
          color: #4CAF50;
          font-weight: bold;
          text-align: center;
        }
        .win-rate.negative {
          color: #f44336;
          text-align: center;
        }
        .kda {
          color: #ffa500;
          font-weight: bold;
          text-align: center;
        }
        .damage {
          color: #e91e63;
          text-align: center;
        }
        .total-kda {
          text-align: center;
          font-size: 12px;
          color: #bbb;
        }
        .player-name {
          color: #fff;
          text-decoration: none;
          font-weight: bold;
        }
        .player-name:hover {
          color: #ffa500;
        }
        .hero {
          color: #9c27b0;
          text-align: center;
        }
        .loading {
          text-align: center;
          padding: 40px;
          color: #888;
          font-size: 16px;
        }
        .error {
          color: #f44336;
          padding: 20px;
          text-align: center;
        }
      `;
          document.head.appendChild(style);
        })
        .catch((err) => {
          document.getElementById(
            "summary"
          ).innerHTML = `<div class="error">Error: ${err.message}</div>`;
          console.error(err);
        });
    </script>
  </body>
</html>
